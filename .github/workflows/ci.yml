name: CI — lint, typecheck, format check, conditional build

# PR 時に ESLint / TypeScript 型チェック / Prettier のフォーマットチェックを実行します。
# さらに、送信元が `release/*` または `hotfix/*`、あるいは PR のターゲットが `main` の場合にのみ
# ビルド（重いため限定実行）を行います。

on:
  pull_request:
    # 全てのターゲットブランチの PR を監視（ただしビルドは条件付きで実行）
    types: [opened, synchronize, reopened]

jobs:
  checks:
    name: Lint / Typecheck / Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Use Node.js v24
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ESLint
        run: pnpm run lint

      - name: Typecheck
        run: pnpm run typecheck

      - name: Prettier format check
        run: pnpm run format:check

  build:
    name: Conditional Build
    runs-on: ubuntu-latest
    needs: checks
    # ビルドは重いため、送信元が release/* または hotfix/*、あるいは PR のターゲットが main の場合のみ実行
    if: ${{ startsWith(github.event.pull_request.head.ref, 'release/') || startsWith(github.event.pull_request.head.ref, 'hotfix/') || github.event.pull_request.base.ref == 'main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - run: corepack enable
      - name: Use Node.js v24
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Build success message
        run: echo "Build completed for conditional branch or main target."
